<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PrepperZero – Food Library</title>
  <link rel="dns-prefetch" href="//10.42.0.1">
  <link rel="preload" href="css/design-system.css" as="style">
  <link rel="stylesheet" href="css/design-system.css">
</head>
<body>
  <div class="pz-container">
    <aside class="pz-sidebar" role="navigation" aria-label="Main navigation">
      <div class="pz-sidebar-header">
        <h1 class="pz-logo">PrepperZero</h1>
        <button class="pz-sidebar-toggle" aria-label="Toggle sidebar" aria-expanded="false">
          <span></span><span></span><span></span>
        </button>
      </div>
      <nav>
        <ul class="pz-nav-list">
          <li><a href="index.html" class="pz-nav-item"><span class="icon">??</span><span>Dashboard</span></a></li>
          <li><a href="maps.html" class="pz-nav-item"><span class="icon">???</span><span>Maps</span></a></li>
          <li><a href="library.html" class="pz-nav-item pz-nav-active"><span class="icon">??</span><span>Library</span></a></li>
          <li><a href="tools.html" class="pz-nav-item"><span class="icon">??</span><span>Tools</span></a></li>
          <li><a href="games.html" class="pz-nav-item"><span class="icon">??</span><span>Games</span></a></li>
          <li><a href="settings.html" class="pz-nav-item"><span class="icon">??</span><span>Settings</span></a></li>
          <li><a href="ap_settings.html" class="pz-nav-item"><span class="icon">??</span><span>Wi-Fi</span></a></li>
        </ul>
      </nav>
      <div class="pz-sidebar-spacer"></div>
      <div class="pz-sidebar-footer"><p>Offline Server<br>No Internet Required</p></div>
    </aside>

    <div class="pz-main">
      <header class="pz-header">
        <div class="pz-header-left"><h1 class="pz-page-title">Food Library</h1></div>
        <div class="pz-header-right">
          <div class="pz-status-indicators">
            <span class="pz-status-pill"><span class="pz-status-dot"></span>Online</span>
          </div>
        </div>
      </header>

      <div class="pz-content">

        <section class="pz-section">
          <div class="pz-section-header">
            <a href="library.html" class="pz-button pz-button-secondary pz-button-small" style="margin-bottom: 1.5rem; display: inline-block;">
              ? Back to Library
            </a>
            <h2>Agricultural ZIM Collections</h2>
            <p>Auto-discovered from Kiwix services (8081/8082).</p>
          </div>
          <div class="pz-grid" id="zim-grid">
            <div class="pz-card"><p class="muted">Scanning for agricultural ZIMs...</p></div>
          </div>
        </section>

        <section class="pz-section">
          <div class="pz-section-header">
            <h2>Preservation & Gardening Guides</h2>
            <p>Curated PDF manuals from local storage.</p>
          </div>
          <div class="pz-grid" id="pdf-grid">
            <div class="pz-card"><p class="muted">Loading PDF repository...</p></div>
          </div>
        </section>

      </div>

      <footer class="pz-footer"><p>PrepperZero Food Library — No internet required</p></footer>
    </div>
  </div>

  <script src="js/sidebar-toggle.js"></script>
  <script src="js/pdf-loader.js"></script>
  <script>
    // Logic: PDF Loader
    loadPDFs("food", "pdf-grid");

    // Logic: ZIM Discovery
    async function fetchZimList(port) {
      try {
        const res = await fetch(`http://${window.location.hostname}:${port}/library`);
        if (!res.ok) return [];
        const xml = await res.text();
        const doc = new DOMParser().parseFromString(xml, "text/xml");
        return [...doc.getElementsByTagName("entry")].map(e => ({
          id: e.getAttribute("id"),
          title: e.getAttribute("title") || "",
          description: e.getAttribute("description") || "",
          port
        }));
      } catch { return []; }
    }

    function isFoodRelated(z) {
      const t = (z.title + " " + z.description).toLowerCase();
      return ["food", "garden", "farm", "agricult", "livestock", "permicult", "pantry", "cook"].some(k => t.includes(k));
    }

    async function loadFoodZims() {
      const all = (await Promise.all([fetchZimList(8081), fetchZimList(8082)])).flat().filter(isFoodRelated);
      const grid = document.getElementById("zim-grid");
      if (!all.length) {
        grid.innerHTML = '<div class="pz-card"><p class="muted">No agricultural ZIMs found.</p></div>';
        return;
      }
      grid.innerHTML = all.map(z => `
        <a class="pz-card" href="http://${window.location.hostname}:${z.port}/${z.id}/">
          <h3>${z.title}</h3>
          <p>${z.description || "Food security reference"}</p>
        </a>`).join('');
    }

    loadFoodZims();

    // Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(e => console.warn('[SW]', e.message));
    }
  </script>
</body>
</html>